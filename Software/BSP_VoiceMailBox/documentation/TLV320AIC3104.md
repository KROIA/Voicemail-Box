# TLV320AIC3104 Audio codec
>The TLV320AIC3104 is a low-power stereo audio codec with stereo headphone amplifier, 
as well as multiple inputs and outputs that are programmable in single-ended or fully differential configurations. 
The device includes extensive register-based power control is included, thus enabling stereo 48-kHz DAC
playback as low as 14 mW from a 3.3-V analog supply, 
making the device ideal for portable battery-powered audio and telephony applications.

Source from the datasheet: [TLV320AIC3104](https://www.ti.com/product/de-de/TLV320AIC3104)

## Features
This codec is very complex and features much more than needed for the Voice Mail Box.
The most features are therefore not implemented into the class for easy usage.
The following features are implemented so far:
- Starting and stopping of the I2S DMA
- Easy access to the microphone and speaker data arrays.
- Performance benchmarking for checking audio processing time vs DMA time
- Setting the microphone gain in dB
  

## Setup
The audio codec uses a I2C for configuration, a I2S for audio sample transfer and an digital reset pin.
Visit the following pages to setup a I2C, I2S one digital output pin.
[I2C setup](I2C.md/#setup)
[I2S setup](I2S.md/#setup)
[Digital Pin setup](DigitalPin.md/#setup)



## Usage
CubeMX generates a **I2S_HandleTypeDef** and **I2C_HandleTypeDef** instance in the **main.c**
The **Codec_TLV320AIC3104** class needs access to these handles. Since the C++ code can't be used directly in the **main.c**, another way of getting to the handle is needed.
Make sure the C++ application is setup, you can find the instructions on how to do so [here](CppFromC.md).

#### Modify main.h and main.c
In the **main.h** create a get function that returns a pointer to the handles.
``` C
// main.h

// Function declaration
I2S_HandleTypeDef* getI2S_handle();
I2C_HandleTypeDef* getI2C_handle();
```

``` C
// main.c

/* Private variables generated by CubeMX */
I2S_HandleTypeDef hi2s1;
I2C_HandleTypeDef hi2c1;

/* USER CODE BEGIN PV */
// Function implementation
I2S_HandleTypeDef* getI2S_handle()
{
    // Return the pointer to the handle
    return &hi2s1;
}
I2C_HandleTypeDef* getI2C_handle()
{
    // Return the pointer to the handle
    return &hi2c1;
}
/* USER CODE END PV */
```

#### Inside the C++ Application


``` C++ 
// Application.cpp
#include "BSP_VoiceMailBox.hpp" // includes the needed peripheral headers
#include "main.h" // Is needed to access the handle get function

// using a namespace globaly is not recommended for production
// but it simplyfies the example here
using namespace VoiceMailBox; 

// Create a codec object and providing the I2S and I2C haldes.
// 1024 for the I2S buffer size which is only used when the macro "VMB_I2S_USE_STATIC_BUFFER_SIZE" is not defined in the settings.h.
// 0x18 is the default I2C address of the TLV320AIC3104 and can be found in its datasheet.
// GPIO_TypeDef* and pin must be passed. It is the Reset pin of the codec: PIN 31.
Codec_TLV320AIC3104 codec(getI2S_handle(), 1024,
                          getI2C_handle(), 0x18,
                          CODEC_NRESET_GPIO_Port, CODEC_NRESET_Pin);

void setup()
{ 
    codec.setup();
}

// Called periodically
void loop()
{
    // Process the codecs audio data
    if (codec.isDataReadyAndClearFlag())
    {
        int16_t* txBuffer = (int16_t*)codec.getTxBufPtr();
        int16_t* rxBuffer = (int16_t*)codec.getRxBufPtr();
        uint32_t size = codec.getBufferSize();

        // Redirect capture to the output
        memcpy(txBuffer, rxBuffer, size * sizeof(int16_t));
    }
}
```