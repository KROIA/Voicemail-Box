# I2C
This class is a simplfied interface to access the i2s peripheral.
Only basic functions, which are used in the project, are implemented.
The implementation does use a DMA for RX and TX.

- [Features](#features)
- [Setup](#setup)
- [Usage](#usage)
    - [Modify main.h and main.c](#modify-mainh-and-mainc)
    - [Inside the C++ Application](#inside-the-c-application)

---
## Features
- Writing audio samples using a DMA
- Receaving audio samples using a DMA

---
## Setup    
### Inside CubeMX, configure your i2s interface.
  **Mode:** *Full-Duplex Master*
  :white_check_mark: **Master Clock Output**

#### Parameter Settings:
**Transmission Mode:** *Mode Master Transmit*
**Communication Standard:** *I2S Philips*
**Data and Frame Format:** *16Bit Data on 16 Bits Frame*
**Selected Audio Frequency:** *48KHz*
			
#### DMA Settings:
- SPI2_TX:
**Mode:** *Circular*
**Data Width:** *Half Word*


Now start the code generation and open the code editor.

---
## Usage
CubeMX generates a **I2S_HandleTypeDef** instance in the **main.c**
The **I2S** class needs access to that handle. Since the C++ code can't be used directly in the **main.c**, another way of getting to the handle is needed.
Make sure the C++ application is setup, you can find the instructions on how to do so [here](CppFromC.md).

#### Modify main.h and main.c
In the **main.h** create a get function that returns a pointer to the handle we want.
``` C
// main.h

// Function declaration
I2S_HandleTypeDef* getI2S_handle();
```

``` C
// main.c

/* Private variables generated by CubeMX */
I2S_HandleTypeDef hi2s1;

/* USER CODE BEGIN PV */
// Function implementation
I2S_HandleTypeDef* getI2S_handle()
{
    // Return the pointer to the handle
    return &hi2s1;
}
/* USER CODE END PV */
```

#### Inside the C++ Application
``` C++ 
// Application.cpp
#include "BSP_VoiceMailBox.hpp" // includes "peripherals/DigitalPin.hpp"
#include "main.h" // Is needed to access the handle get function
#include <cstring> // Used for memcpy()

// using a namespace globaly is not recommended for production
// but it simplyfies the example here
using namespace VoiceMailBox; 

// Create a I2C object and providing the handle from the main.c
// Use a int16_t[1024] array for data in and out.
I2S i2s(getI2S_handle(), 1024);

void setup()
{ 
    // Start the DMA for RX and TX data transfers
    i2s.startDMA(); 
}

// Called periodically
void loop()
{
    // Check if there was a Ping-Pong swap, triggered by the DMA ISR
    if(i2s.isDataReadyAndClearFlag())
    {
        // Process microphone input and create new audio output
        volatile int16_t* microphoneSamples = i2s.getRxBufPtr();
        volatile int16_t* audioOutSamples = i2s.getTxBufPtr();

        // Size of the current ping or pong buffer
        uint32_t bufferSize = i2s.getBufferSize();

        // Example processing: 
        // Stream the microphone directly back to the output
        memcpy(audioOutSamples, microphoneSamples, bufferSize * sizeof(int16_t));
    }
}
```


``` C++ 

```